{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–ß–∞—Ç—ã</h1>
    <div class="input-group" style="max-width: 300px;">
        <input type="text" id="search-input" class="form-control" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤...">
        <button class="btn btn-primary" type="button" id="search-button">
            <i class="bi bi-search"></i>
        </button>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4" id="statistics-row" style="display: none;">
    <div class="col-md-12">
        <h5 class="mb-3">
            <i class="bi bi-bar-chart text-primary"></i>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        </h5>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-chat-text text-primary"></i>
                    –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –±–æ—Ç–æ–º
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-success" id="messages-today">0</div>
                            <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-info" id="messages-week">0</div>
                            <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-warning" id="messages-month">0</div>
                            <div class="stat-label">–ó–∞ –º–µ—Å—è—Ü</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-primary" id="messages-all-time">0</div>
                            <div class="stat-label">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-people text-primary"></i>
                    –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ 
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-success" id="chats-today">0</div>
                            <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                            <div class="instruction-requests-small" id="instruction-requests-chats-today">üìã 0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-info" id="chats-week">0</div>
                            <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                            <div class="instruction-requests-small" id="instruction-requests-chats-week">üìã 0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-warning" id="chats-month">0</div>
                            <div class="stat-label">–ó–∞ –º–µ—Å—è—Ü</div>
                            <div class="instruction-requests-small" id="instruction-requests-chats-month">üìã 0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-item">
                            <div class="stat-number text-primary" id="chats-all-time">0</div>
                            <div class="stat-label">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
                            <div class="instruction-requests-small" id="instruction-requests-chats-all-time">üìã 0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-funnel"></i>
                –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            </h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filters-collapse">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
    </div>
    <div class="collapse" id="filters-collapse">
        <div class="card-body">
            <div class="row g-3">
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
                <div class="col-md-4">
                    <label for="date-filter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</label>
                    <select class="form-select" id="date-filter">
                        <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="yesterday">–í—á–µ—Ä–∞</option>
                        <option value="custom">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</option>
                    </select>
                </div>
                
                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –¥–∞—Ç–∞ -->
                <div class="col-md-4">
                    <label for="custom-date" class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="form-control" id="custom-date" disabled>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞–º -->
                <div class="col-md-4">
                    <label for="apartments-filter" class="form-label">–ê–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</label>
                    <select class="form-select" id="apartments-filter">
                        <option value="">–í—Å–µ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </select>
                </div>
                
                <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <div class="col-md-3">
                    <label for="sort-by" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                    <select class="form-select" id="sort-by">
                        <option value="last_message_date" selected>–î–∞—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è</option>
                        <option value="updated_at">–î–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
                    </select>
                </div>
                
                <!-- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
                <div class="col-md-3">
                    <label for="sort-order" class="form-label">–ü–æ—Ä—è–¥–æ–∫</label>
                    <select class="form-select" id="sort-order">
                        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                    </select>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" id="apply-filters">
                        <i class="bi bi-check2"></i>
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-outline-secondary" id="reset-filters">
                        <i class="bi bi-arrow-clockwise"></i>
                        –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="chats-list">
                    <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="text-center py-5" id="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                    </div>
                    <div class="text-center py-5 d-none" id="no-chats">
                        <i class="bi bi-chat-dots display-4 text-muted"></i>
                        <p class="mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
}

.stat-item {
    padding: 0.5rem 0;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    let updateInterval = null;
    // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    let isSearchActive = false;
    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    let lastSearchQuery = '';
    // –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    let currentFilters = {
        date_filter: '',
        custom_date: '',
        apartments_filter: '',
        sort_by: 'last_message_date',
        sort_order: 'desc'
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤
    async function loadApartments() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤');
            return;
        }
        
        try {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤...');
            const response = await fetch('/api/chats/apartments', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', response.status);
                return;
            }
            
            const apartments = await response.json();
            console.log('–ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', apartments);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º select —ç–ª–µ–º–µ–Ω—Ç
            const apartmentsSelect = document.getElementById('apartments-filter');
            if (apartmentsSelect) {
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                apartmentsSelect.innerHTML = '<option value="">–í—Å–µ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã</option>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
                apartments.forEach(apartment => {
                    const option = document.createElement('option');
                    option.value = apartment;
                    option.textContent = apartment;
                    apartmentsSelect.appendChild(option);
                });
                
                console.log('–°–ø–∏—Å–æ–∫ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStatistics() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            return;
        }
        
        try {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
            const response = await fetch('/api/stats/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            console.log('–û—Ç–≤–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', errorText);
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + response.status + ' - ' + errorText);
            }
            
            const data = await response.json();
            console.log('–î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
            if (!data.messages || !data.chats || !data.instruction_requests) {
                console.error('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesElements = {
                today: document.getElementById('messages-today'),
                week: document.getElementById('messages-week'),
                month: document.getElementById('messages-month'),
                allTime: document.getElementById('messages-all-time')
            };
            
            if (messagesElements.today) {
                messagesElements.today.textContent = data.messages.today;
                console.log('–°–æ–æ–±—â–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è:', data.messages.today);
            }
            if (messagesElements.week) {
                messagesElements.week.textContent = data.messages.week;
                console.log('–°–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é:', data.messages.week);
            }
            if (messagesElements.month) {
                messagesElements.month.textContent = data.messages.month;
                console.log('–°–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –º–µ—Å—è—Ü:', data.messages.month);
            }
            if (messagesElements.allTime) {
                messagesElements.allTime.textContent = data.messages.all_time;
                console.log('–°–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è:', data.messages.all_time);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
            const chatsElements = {
                today: document.getElementById('chats-today'),
                week: document.getElementById('chats-week'),
                month: document.getElementById('chats-month'),
                allTime: document.getElementById('chats-all-time')
            };
            
            if (chatsElements.today) {
                chatsElements.today.textContent = data.chats.today;
                console.log('–î–∏–∞–ª–æ–≥–∏ —Å–µ–≥–æ–¥–Ω—è:', data.chats.today);
            }
            if (chatsElements.week) {
                chatsElements.week.textContent = data.chats.week;
                console.log('–î–∏–∞–ª–æ–≥–∏ –∑–∞ –Ω–µ–¥–µ–ª—é:', data.chats.week);
            }
            if (chatsElements.month) {
                chatsElements.month.textContent = data.chats.month;
                console.log('–î–∏–∞–ª–æ–≥–∏ –∑–∞ –º–µ—Å—è—Ü:', data.chats.month);
            }
            if (chatsElements.allTime) {
                chatsElements.allTime.textContent = data.chats.all_time;
                console.log('–î–∏–∞–ª–æ–≥–∏ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è:', data.chats.all_time);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Ç–æ–ª—å–∫–æ –≤ –±–ª–æ–∫–µ "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
            const instructionElements = {
                chatsToday: document.getElementById('instruction-requests-chats-today'),
                chatsWeek: document.getElementById('instruction-requests-chats-week'),
                chatsMonth: document.getElementById('instruction-requests-chats-month'),
                chatsAllTime: document.getElementById('instruction-requests-chats-all-time')
            };
            
            if (instructionElements.chatsToday) {
                instructionElements.chatsToday.textContent = `üìã ${data.instruction_requests.today}`;
                console.log('–ó–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è:', data.instruction_requests.today);
            }
            if (instructionElements.chatsWeek) {
                instructionElements.chatsWeek.textContent = `üìã ${data.instruction_requests.week}`;
                console.log('–ó–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é:', data.instruction_requests.week);
            }
            if (instructionElements.chatsMonth) {
                instructionElements.chatsMonth.textContent = `üìã ${data.instruction_requests.month}`;
                console.log('–ó–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ –º–µ—Å—è—Ü:', data.instruction_requests.month);
            }
            if (instructionElements.chatsAllTime) {
                instructionElements.chatsAllTime.textContent = `üìã ${data.instruction_requests.all_time}`;
                console.log('–ó–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è:', data.instruction_requests.all_time);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const statisticsRow = document.getElementById('statistics-row');
            if (statisticsRow) {
                statisticsRow.style.display = 'flex';
                console.log('–ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω');
            }
            
            console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const statisticsRow = document.getElementById('statistics-row');
            if (statisticsRow) {
                statisticsRow.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: ${error.message}
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadStatistics()">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                statisticsRow.style.display = 'flex';
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å UTC+5
        const timeZone = 'Asia/Yekaterinburg';
        const localDate = new Date(date.toLocaleString('en-US', { timeZone }));
        const localNow = new Date(now.toLocaleString('en-US', { timeZone }));
        
        const today = new Date(localNow.getFullYear(), localNow.getMonth(), localNow.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (localDate >= today) {
            // –°–µ–≥–æ–¥–Ω—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
            return localDate.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone 
            });
        } else if (localDate >= yesterday) {
            // –í—á–µ—Ä–∞
            return '–í—á–µ—Ä–∞';
        } else {
            // –î—Ä—É–≥–∏–µ –¥–Ω–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
            return localDate.toLocaleDateString('ru-RU', { timeZone });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    function buildChatsUrl() {
        let url = '/api/chats/';
        const params = new URLSearchParams();
        
        if (currentFilters.date_filter) {
            params.append('date_filter', currentFilters.date_filter);
        }
        
        if (currentFilters.custom_date) {
            params.append('custom_date', currentFilters.custom_date);
        }
        
        if (currentFilters.apartments_filter) {
            params.append('apartments_filter', currentFilters.apartments_filter);
        }
        
        params.append('sort_by', currentFilters.sort_by);
        params.append('sort_order', currentFilters.sort_order);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        console.log('–ü–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π URL:', url);
        console.log('–¢–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã:', currentFilters);
        
        return url;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤
    async function loadChats() {
        if (isSearchActive) return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ–∏—Å–∫
        
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        try {
            const url = buildChatsUrl();
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Å URL:', url);
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 401) {
                    // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', errorText);
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤: ' + response.status);
            }
            
            const chats = await response.json();
            console.log('–ü–æ–ª—É—á–µ–Ω–æ —á–∞—Ç–æ–≤:', chats.length);
            console.log('–î–∞–Ω–Ω—ã–µ —á–∞—Ç–æ–≤:', chats);
            
            displayChats(chats);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            const chatsList = document.getElementById('chats-list');
            
            if (chatsList) {
                chatsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                        <p class="mt-2">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadChats()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
        const dateFilter = document.getElementById('date-filter').value;
        const customDate = document.getElementById('custom-date').value;
        const apartmentsFilter = document.getElementById('apartments-filter').value;
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;
        
        console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã:', { dateFilter, customDate, apartmentsFilter, sortBy, sortOrder });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
        if (isSearchActive) {
            console.log('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤');
            isSearchActive = false;
            lastSearchQuery = '';
            document.getElementById('search-input').value = '';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
        currentFilters = {
            date_filter: dateFilter === 'custom' ? '' : dateFilter,
            custom_date: dateFilter === 'custom' ? customDate : '',
            apartments_filter: apartmentsFilter,
            sort_by: sortBy,
            sort_order: sortOrder
        };
        
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:', currentFilters);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const chatsList = document.getElementById('chats-list');
        
        if (chatsList) {
            chatsList.innerHTML = `
                <div class="text-center py-5" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                </div>
                <div class="text-center py-5 d-none" id="no-chats">
                    <i class="bi bi-chat-dots display-4 text-muted"></i>
                    <p class="mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                </div>
            `;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Å –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        loadChats();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetFilters() {
        console.log('–°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        document.getElementById('date-filter').value = '';
        document.getElementById('custom-date').value = '';
        document.getElementById('custom-date').disabled = true;
        document.getElementById('apartments-filter').value = '';
        document.getElementById('sort-by').value = 'last_message_date';
        document.getElementById('sort-order').value = 'desc';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
        if (isSearchActive) {
            console.log('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫');
            isSearchActive = false;
            lastSearchQuery = '';
            document.getElementById('search-input').value = '';
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
        currentFilters = {
            date_filter: '',
            custom_date: '',
            apartments_filter: '',
            sort_by: 'last_message_date',
            sort_order: 'desc'
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const chatsList = document.getElementById('chats-list');
        
        if (chatsList) {
            chatsList.innerHTML = `
                <div class="text-center py-5" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                </div>
                <div class="text-center py-5 d-none" id="no-chats">
                    <i class="bi bi-chat-dots display-4 text-muted"></i>
                    <p class="mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                </div>
            `;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
        loadChats();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–∞—Ç–æ–≤
    function displayChats(chats) {
        const chatsList = document.getElementById('chats-list');
        let loading = document.getElementById('loading');
        let noChats = document.getElementById('no-chats');
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º loading –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (loading) {
            loading.classList.add('d-none');
        }
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º noChats –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (noChats) {
            noChats.classList.add('d-none');
        }
        
        if (chats.length === 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã
            const hasFilters = currentFilters.date_filter || currentFilters.custom_date || 
                             currentFilters.apartments_filter || currentFilters.sort_by !== 'last_message_date' || 
                             currentFilters.sort_order !== 'desc';
            
            if (hasFilters) {
                if (chatsList) {
                    chatsList.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-funnel display-4 text-muted"></i>
                            <h5 class="mt-3">–ù–µ—Ç —á–∞—Ç–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</h5>
                            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏—Ö</p>
                            <button class="btn btn-outline-primary" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i>
                                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>
                    `;
                }
            } else {
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç noChats –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                if (!noChats && chatsList) {
                    chatsList.innerHTML = `
                        <div class="text-center py-5" id="no-chats">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                        </div>
                    `;
                } else if (noChats) {
                    noChats.classList.remove('d-none');
                }
            }
            return;
        }
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        if (chatsList) {
            chatsList.innerHTML = '';
        }
        
        console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–∞—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ:');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç—ã –≤ —Å–ø–∏—Å–æ–∫
        chats.forEach((chat, index) => {
            console.log(`${index + 1}. –ß–∞—Ç ID: ${chat.id}, –û–±–Ω–æ–≤–ª–µ–Ω: ${chat.updated_at}, –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${chat.last_message ? chat.last_message.created_at : '–Ω–µ—Ç'}`);
            
            const lastMessageText = chat.last_message ? 
                (chat.last_message.is_from_manager ? '–í—ã: ' : '') + chat.last_message.text : 
                '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            
            const lastMessageDate = chat.last_message ? 
                formatDate(chat.last_message.created_at) : '';
            
            const chatName = chat.title || 
                (chat.telegram_user ? 
                    (chat.telegram_user.username ? 
                        '@' + chat.telegram_user.username : 
                        chat.telegram_user.first_name + (chat.telegram_user.last_name ? ' ' + chat.telegram_user.last_name : '')
                    ) : 
                    '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                );
            
            const unreadBadge = chat.unread_count > 0 ? 
                `<span class="badge bg-primary rounded-pill">${chat.unread_count}</span>` : 
                '';
            
            const chatItem = document.createElement('a');
            chatItem.href = `/chats/${chat.id}`;
            chatItem.className = 'list-group-item list-group-item-action';
            chatItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">${chatName}</h5>
                        <p class="mb-1 text-truncate" style="max-width: 500px;">${lastMessageText}</p>
                        <small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω: ${new Date(chat.updated_at).toLocaleString('ru-RU', { timeZone: 'Asia/Yekaterinburg' })}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">${lastMessageDate}</small>
                        ${unreadBadge}
                    </div>
                </div>
            `;
            
            if (chatsList) {
                chatsList.appendChild(chatItem);
            }
        });
        
        console.log(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${chats.length} —á–∞—Ç–æ–≤`);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    async function searchChats(query) {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–∏—Å–∫–∞
        isSearchActive = !!query;
        lastSearchQuery = query;
        
        try {
            const response = await fetch(`/api/chats/search/?query=${encodeURIComponent(query)}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —á–∞—Ç–æ–≤');
            }
            
            const chats = await response.json();
            
            const chatsList = document.getElementById('chats-list');
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            chatsList.innerHTML = '';
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-search display-4 text-muted"></i>
                        <p class="mt-2">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"</p>
                        <button class="btn btn-outline-primary" onclick="resetSearch()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —á–∞—Ç—ã</button>
                    </div>
                `;
                return;
            }
            
            displayChats(chats);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            const chatsList = document.getElementById('chats-list');
            
            chatsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                    <p class="mt-2">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —á–∞—Ç–æ–≤</p>
                    <button class="btn btn-primary" onclick="resetSearch()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —á–∞—Ç—ã</button>
                </div>
            `;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞
    function resetSearch() {
        isSearchActive = false;
        lastSearchQuery = '';
        document.getElementById('search-input').value = '';
        loadChats();
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    function startAutoUpdate() {
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (updateInterval) {
            clearInterval(updateInterval);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
        updateInterval = setInterval(() => {
            if (isSearchActive) {
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ–∏—Å–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                searchChats(lastSearchQuery);
            } else {
                // –ò–Ω–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                loadChats();
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                loadStatistics();
            }
        }, 30000);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('sort-by').value = 'last_message_date';
        document.getElementById('sort-order').value = 'desc';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–ø–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤
        loadApartments();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        loadStatistics();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
        loadChats();
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        startAutoUpdate();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('date-filter').addEventListener('change', function() {
            const customDateInput = document.getElementById('custom-date');
            if (this.value === 'custom') {
                customDateInput.disabled = false;
                customDateInput.required = true;
            } else {
                customDateInput.disabled = true;
                customDateInput.required = false;
                customDateInput.value = '';
            }
        });
        
        document.getElementById('apply-filters').addEventListener('click', applyFilters);
        document.getElementById('reset-filters').addEventListener('click', resetFilters);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
    document.getElementById('search-button').addEventListener('click', function() {
        const query = document.getElementById('search-input').value.trim();
        if (query) {
            searchChats(query);
        } else {
            resetSearch();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                searchChats(query);
            } else {
                resetSearch();
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–∫–∏ (–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            if (isSearchActive) {
                searchChats(lastSearchQuery);
            } else {
                loadChats();
                loadStatistics();
            }
            startAutoUpdate();
        } else {
            clearInterval(updateInterval);
        }
    });
</script>
{% endblock %} 