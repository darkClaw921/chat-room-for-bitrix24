{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Чаты</h1>
    <div class="input-group" style="max-width: 300px;">
        <input type="text" id="search-input" class="form-control" placeholder="Поиск чатов...">
        <button class="btn btn-primary" type="button" id="search-button">
            <i class="bi bi-search"></i>
        </button>
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4" id="statistics-row" style="display: none;">
    <div class="col-md-12">
        <h5 class="mb-3">
            <i class="bi bi-bar-chart text-primary"></i>
            Статистика активности
        </h5>
    </div>
    
    <!-- Статистика сообщений -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-chat-text text-primary"></i>
                    Взаимодействий с ботом
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-success" id="messages-today">0</div>
                            <div class="stat-label">Сегодня</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-info" id="messages-week">0</div>
                            <div class="stat-label">За неделю</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-warning" id="messages-month">0</div>
                            <div class="stat-label">За месяц</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Статистика диалогов -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-people text-primary"></i>
                    Новые пользователи 
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-success" id="chats-today">0</div>
                            <div class="stat-label">Сегодня</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-info" id="chats-week">0</div>
                            <div class="stat-label">За неделю</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-number text-warning" id="chats-month">0</div>
                            <div class="stat-label">За месяц</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Панель фильтров и сортировки -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-funnel"></i>
                Фильтры и сортировка
            </h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filters-collapse">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
    </div>
    <div class="collapse" id="filters-collapse">
        <div class="card-body">
            <div class="row g-3">
                <!-- Фильтр по дате -->
                <div class="col-md-4">
                    <label for="date-filter" class="form-label">Фильтр по дате</label>
                    <select class="form-select" id="date-filter">
                        <option value="">Все время</option>
                        <option value="today">Сегодня</option>
                        <option value="yesterday">Вчера</option>
                        <option value="custom">Выбрать дату</option>
                    </select>
                </div>
                
                <!-- Пользовательская дата -->
                <div class="col-md-4">
                    <label for="custom-date" class="form-label">Дата</label>
                    <input type="date" class="form-control" id="custom-date" disabled>
                </div>
                
                <!-- Фильтр по аппартаментам -->
                <div class="col-md-4">
                    <label for="apartments-filter" class="form-label">Аппартаменты</label>
                    <select class="form-select" id="apartments-filter">
                        <option value="">Все аппартаменты</option>
                        <!-- Опции будут загружены через JavaScript -->
                    </select>
                </div>
                
                <!-- Сортировка -->
                <div class="col-md-3">
                    <label for="sort-by" class="form-label">Сортировать по</label>
                    <select class="form-select" id="sort-by">
                        <option value="last_message_date">Дате сообщения</option>
                        <option value="updated_at">Дате обновления</option>
                    </select>
                </div>
                
                <!-- Порядок сортировки -->
                <div class="col-md-3">
                    <label for="sort-order" class="form-label">Порядок</label>
                    <select class="form-select" id="sort-order">
                        <option value="desc">По убыванию</option>
                        <option value="asc">По возрастанию</option>
                    </select>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" id="apply-filters">
                        <i class="bi bi-check2"></i>
                        Применить
                    </button>
                    <button class="btn btn-outline-secondary" id="reset-filters">
                        <i class="bi bi-arrow-clockwise"></i>
                        Сбросить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="chats-list">
                    <!-- Чаты будут загружены через JavaScript -->
                    <div class="text-center py-5" id="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка чатов...</p>
                    </div>
                    <div class="text-center py-5 d-none" id="no-chats">
                        <i class="bi bi-chat-dots display-4 text-muted"></i>
                        <p class="mt-2">У вас пока нет активных чатов</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
}

.stat-item {
    padding: 0.5rem 0;
}

.card-header.bg-light {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Интервал для периодического обновления списка чатов
    let updateInterval = null;
    // Флаг активного поиска
    let isSearchActive = false;
    // Последний поисковый запрос
    let lastSearchQuery = '';
    // Текущие параметры фильтрации
    let currentFilters = {
        date_filter: '',
        custom_date: '',
        apartments_filter: '',
        sort_by: 'updated_at',
        sort_order: 'desc'
    };

    // Функция для загрузки списка аппартаментов
    async function loadApartments() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('Нет токена для загрузки аппартаментов');
            return;
        }
        
        try {
            console.log('Загружаем список аппартаментов...');
            const response = await fetch('/api/chats/apartments', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                console.error('Ошибка при загрузке аппартаментов:', response.status);
                return;
            }
            
            const apartments = await response.json();
            console.log('Получен список аппартаментов:', apartments);
            
            // Обновляем select элемент
            const apartmentsSelect = document.getElementById('apartments-filter');
            if (apartmentsSelect) {
                // Очищаем текущие опции кроме первой
                apartmentsSelect.innerHTML = '<option value="">Все аппартаменты</option>';
                
                // Добавляем опции для каждого аппартамента
                apartments.forEach(apartment => {
                    const option = document.createElement('option');
                    option.value = apartment;
                    option.textContent = apartment;
                    apartmentsSelect.appendChild(option);
                });
                
                console.log('Список аппартаментов обновлен');
            }
            
        } catch (error) {
            console.error('Ошибка при загрузке аппартаментов:', error);
        }
    }

    // Функция для загрузки статистики
    async function loadStatistics() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('Нет токена для загрузки статистики');
            return;
        }
        
        try {
            console.log('Загружаем статистику...');
            const response = await fetch('/api/stats/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            console.log('Ответ статистики:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Ошибка ответа статистики:', errorText);
                throw new Error('Ошибка при загрузке статистики: ' + response.status + ' - ' + errorText);
            }
            
            const data = await response.json();
            console.log('Данные статистики:', data);
            
            // Проверяем структуру данных
            if (!data.messages || !data.chats) {
                console.error('Неправильная структура данных статистики:', data);
                return;
            }
            
            // Обновляем счетчики сообщений
            const messagesElements = {
                today: document.getElementById('messages-today'),
                week: document.getElementById('messages-week'),
                month: document.getElementById('messages-month')
            };
            
            if (messagesElements.today) {
                messagesElements.today.textContent = data.messages.today;
                console.log('Сообщения сегодня:', data.messages.today);
            }
            if (messagesElements.week) {
                messagesElements.week.textContent = data.messages.week;
                console.log('Сообщения за неделю:', data.messages.week);
            }
            if (messagesElements.month) {
                messagesElements.month.textContent = data.messages.month;
                console.log('Сообщения за месяц:', data.messages.month);
            }
            
            // Обновляем счетчики диалогов
            const chatsElements = {
                today: document.getElementById('chats-today'),
                week: document.getElementById('chats-week'),
                month: document.getElementById('chats-month')
            };
            
            if (chatsElements.today) {
                chatsElements.today.textContent = data.chats.today;
                console.log('Диалоги сегодня:', data.chats.today);
            }
            if (chatsElements.week) {
                chatsElements.week.textContent = data.chats.week;
                console.log('Диалоги за неделю:', data.chats.week);
            }
            if (chatsElements.month) {
                chatsElements.month.textContent = data.chats.month;
                console.log('Диалоги за месяц:', data.chats.month);
            }
            
            // Показываем блок статистики
            const statisticsRow = document.getElementById('statistics-row');
            if (statisticsRow) {
                statisticsRow.style.display = 'flex';
                console.log('Блок статистики показан');
            }
            
            console.log('Статистика загружена успешно');
            
        } catch (error) {
            console.error('Ошибка при загрузке статистики:', error);
            
            // Показываем ошибку пользователю
            const statisticsRow = document.getElementById('statistics-row');
            if (statisticsRow) {
                statisticsRow.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Не удалось загрузить статистику: ${error.message}
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadStatistics()">
                                Повторить
                            </button>
                        </div>
                    </div>
                `;
                statisticsRow.style.display = 'flex';
            }
        }
    }

    // Функция для форматирования даты
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (date >= today) {
            // Сегодня - показываем только время
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (date >= yesterday) {
            // Вчера
            return 'Вчера';
        } else {
            // Другие дни - показываем дату
            return date.toLocaleDateString();
        }
    }
    
    // Функция для создания URL с параметрами фильтрации
    function buildChatsUrl() {
        let url = '/api/chats/';
        const params = new URLSearchParams();
        
        if (currentFilters.date_filter) {
            params.append('date_filter', currentFilters.date_filter);
        }
        
        if (currentFilters.custom_date) {
            params.append('custom_date', currentFilters.custom_date);
        }
        
        if (currentFilters.apartments_filter) {
            params.append('apartments_filter', currentFilters.apartments_filter);
        }
        
        params.append('sort_by', currentFilters.sort_by);
        params.append('sort_order', currentFilters.sort_order);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        console.log('Построенный URL:', url);
        console.log('Текущие фильтры:', currentFilters);
        
        return url;
    }
    
    // Функция для загрузки чатов
    async function loadChats() {
        if (isSearchActive) return; // Не обновляем, если активен поиск
        
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        try {
            const url = buildChatsUrl();
            console.log('Загружаем чаты с URL:', url);
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            console.log('Ответ сервера:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Токен недействителен
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                const errorText = await response.text();
                console.error('Ошибка ответа:', errorText);
                throw new Error('Ошибка при загрузке чатов: ' + response.status);
            }
            
            const chats = await response.json();
            console.log('Получено чатов:', chats.length);
            console.log('Данные чатов:', chats);
            
            displayChats(chats);
            
        } catch (error) {
            console.error('Ошибка:', error);
            const chatsList = document.getElementById('chats-list');
            
            if (chatsList) {
                chatsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                        <p class="mt-2">Ошибка при загрузке чатов: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadChats()">Повторить</button>
                    </div>
                `;
            }
        }
    }
    
    // Функция для применения фильтров
    function applyFilters() {
        // Получаем значения из формы
        const dateFilter = document.getElementById('date-filter').value;
        const customDate = document.getElementById('custom-date').value;
        const apartmentsFilter = document.getElementById('apartments-filter').value;
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;
        
        console.log('Применяем фильтры:', { dateFilter, customDate, apartmentsFilter, sortBy, sortOrder });
        
        // Сбрасываем поиск, если он был активен
        if (isSearchActive) {
            console.log('Сбрасываем активный поиск перед применением фильтров');
            isSearchActive = false;
            lastSearchQuery = '';
            document.getElementById('search-input').value = '';
        }
        
        // Обновляем текущие фильтры
        currentFilters = {
            date_filter: dateFilter === 'custom' ? '' : dateFilter,
            custom_date: dateFilter === 'custom' ? customDate : '',
            apartments_filter: apartmentsFilter,
            sort_by: sortBy,
            sort_order: sortOrder
        };
        
        console.log('Обновленные фильтры:', currentFilters);
        
        // Показываем индикатор загрузки
        const chatsList = document.getElementById('chats-list');
        
        if (chatsList) {
            chatsList.innerHTML = `
                <div class="text-center py-5" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка чатов...</p>
                </div>
                <div class="text-center py-5 d-none" id="no-chats">
                    <i class="bi bi-chat-dots display-4 text-muted"></i>
                    <p class="mt-2">У вас пока нет активных чатов</p>
                </div>
            `;
        }
        
        // Загружаем чаты с новыми фильтрами
        loadChats();
    }
    
    // Функция для сброса фильтров
    function resetFilters() {
        console.log('Сбрасываем фильтры');
        
        // Сбрасываем значения формы
        document.getElementById('date-filter').value = '';
        document.getElementById('custom-date').value = '';
        document.getElementById('custom-date').disabled = true;
        document.getElementById('apartments-filter').value = '';
        document.getElementById('sort-by').value = 'updated_at';
        document.getElementById('sort-order').value = 'desc';
        
        // Сбрасываем поиск, если он был активен
        if (isSearchActive) {
            console.log('Сбрасываем активный поиск');
            isSearchActive = false;
            lastSearchQuery = '';
            document.getElementById('search-input').value = '';
        }
        
        // Сбрасываем текущие фильтры
        currentFilters = {
            date_filter: '',
            custom_date: '',
            apartments_filter: '',
            sort_by: 'updated_at',
            sort_order: 'desc'
        };
        
        // Показываем индикатор загрузки
        const chatsList = document.getElementById('chats-list');
        
        if (chatsList) {
            chatsList.innerHTML = `
                <div class="text-center py-5" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка чатов...</p>
                </div>
                <div class="text-center py-5 d-none" id="no-chats">
                    <i class="bi bi-chat-dots display-4 text-muted"></i>
                    <p class="mt-2">У вас пока нет активных чатов</p>
                </div>
            `;
        }
        
        // Загружаем чаты
        loadChats();
    }
    
    // Функция для отображения чатов
    function displayChats(chats) {
        const chatsList = document.getElementById('chats-list');
        let loading = document.getElementById('loading');
        let noChats = document.getElementById('no-chats');
        
        // Безопасно скрываем loading если он существует
        if (loading) {
            loading.classList.add('d-none');
        }
        
        // Безопасно скрываем noChats если он существует
        if (noChats) {
            noChats.classList.add('d-none');
        }
        
        if (chats.length === 0) {
            // Показываем сообщение в зависимости от того, применены ли фильтры
            const hasFilters = currentFilters.date_filter || currentFilters.custom_date || 
                             currentFilters.apartments_filter || currentFilters.sort_by !== 'updated_at' || 
                             currentFilters.sort_order !== 'desc';
            
            if (hasFilters) {
                if (chatsList) {
                    chatsList.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-funnel display-4 text-muted"></i>
                            <h5 class="mt-3">Нет чатов по заданным фильтрам</h5>
                            <p class="text-muted">Попробуйте изменить параметры фильтрации или сбросить их</p>
                            <button class="btn btn-outline-primary" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Сбросить фильтры
                            </button>
                        </div>
                    `;
                }
            } else {
                // Если элемент noChats не существует, создаем его
                if (!noChats && chatsList) {
                    chatsList.innerHTML = `
                        <div class="text-center py-5" id="no-chats">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="mt-2">У вас пока нет активных чатов</p>
                        </div>
                    `;
                } else if (noChats) {
                    noChats.classList.remove('d-none');
                }
            }
            return;
        }
        
        // Очищаем список
        if (chatsList) {
            chatsList.innerHTML = '';
        }
        
        console.log('Отображаем чаты в порядке:');
        
        // Добавляем чаты в список
        chats.forEach((chat, index) => {
            console.log(`${index + 1}. Чат ID: ${chat.id}, Обновлен: ${chat.updated_at}, Последнее сообщение: ${chat.last_message ? chat.last_message.created_at : 'нет'}`);
            
            const lastMessageText = chat.last_message ? 
                (chat.last_message.is_from_manager ? 'Вы: ' : '') + chat.last_message.text : 
                'Нет сообщений';
            
            const lastMessageDate = chat.last_message ? 
                formatDate(chat.last_message.created_at) : '';
            
            const chatName = chat.title || 
                (chat.telegram_user ? 
                    (chat.telegram_user.username ? 
                        '@' + chat.telegram_user.username : 
                        chat.telegram_user.first_name + (chat.telegram_user.last_name ? ' ' + chat.telegram_user.last_name : '')
                    ) : 
                    'Неизвестный пользователь'
                );
            
            const unreadBadge = chat.unread_count > 0 ? 
                `<span class="badge bg-primary rounded-pill">${chat.unread_count}</span>` : 
                '';
            
            const chatItem = document.createElement('a');
            chatItem.href = `/chats/${chat.id}`;
            chatItem.className = 'list-group-item list-group-item-action';
            chatItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">${chatName}</h5>
                        <p class="mb-1 text-truncate" style="max-width: 500px;">${lastMessageText}</p>
                        <small class="text-muted">Обновлен: ${new Date(chat.updated_at).toLocaleString()}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">${lastMessageDate}</small>
                        ${unreadBadge}
                    </div>
                </div>
            `;
            
            if (chatsList) {
                chatsList.appendChild(chatItem);
            }
        });
        
        console.log(`Отображено ${chats.length} чатов`);
    }
    
    // Функция для поиска чатов
    async function searchChats(query) {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        // Устанавливаем флаг поиска
        isSearchActive = !!query;
        lastSearchQuery = query;
        
        try {
            const response = await fetch(`/api/chats/search/?query=${encodeURIComponent(query)}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка при поиске чатов');
            }
            
            const chats = await response.json();
            
            const chatsList = document.getElementById('chats-list');
            
            // Очищаем список
            chatsList.innerHTML = '';
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-search display-4 text-muted"></i>
                        <p class="mt-2">Ничего не найдено по запросу "${query}"</p>
                        <button class="btn btn-outline-primary" onclick="resetSearch()">Показать все чаты</button>
                    </div>
                `;
                return;
            }
            
            displayChats(chats);
            
        } catch (error) {
            console.error('Ошибка:', error);
            const chatsList = document.getElementById('chats-list');
            
            chatsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                    <p class="mt-2">Ошибка при поиске чатов</p>
                    <button class="btn btn-primary" onclick="resetSearch()">Показать все чаты</button>
                </div>
            `;
        }
    }
    
    // Функция для сброса поиска
    function resetSearch() {
        isSearchActive = false;
        lastSearchQuery = '';
        document.getElementById('search-input').value = '';
        loadChats();
    }
    
    // Запускаем периодическое обновление списка чатов
    function startAutoUpdate() {
        // Очищаем существующий интервал, если есть
        if (updateInterval) {
            clearInterval(updateInterval);
        }
        
        // Устанавливаем новый интервал (обновление каждые 30 секунд)
        updateInterval = setInterval(() => {
            if (isSearchActive) {
                // Если активен поиск, обновляем результаты поиска
                searchChats(lastSearchQuery);
            } else {
                // Иначе обновляем общий список чатов
                loadChats();
                // Также обновляем статистику
                loadStatistics();
            }
        }, 30000);
    }
    
    // Загружаем чаты при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем список аппартаментов
        loadApartments();
        // Загружаем статистику
        loadStatistics();
        // Загружаем чаты
        loadChats();
        // Запускаем автообновление
        startAutoUpdate();
        
        // Обработчики для фильтров
        document.getElementById('date-filter').addEventListener('change', function() {
            const customDateInput = document.getElementById('custom-date');
            if (this.value === 'custom') {
                customDateInput.disabled = false;
                customDateInput.required = true;
            } else {
                customDateInput.disabled = true;
                customDateInput.required = false;
                customDateInput.value = '';
            }
        });
        
        document.getElementById('apply-filters').addEventListener('click', applyFilters);
        document.getElementById('reset-filters').addEventListener('click', resetFilters);
    });
    
    // Обработчик поиска
    document.getElementById('search-button').addEventListener('click', function() {
        const query = document.getElementById('search-input').value.trim();
        if (query) {
            searchChats(query);
        } else {
            resetSearch();
        }
    });
    
    // Обработчик нажатия Enter в поле поиска
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                searchChats(query);
            } else {
                resetSearch();
            }
        }
    });
    
    // Обработчик для видимости вкладки (останавливаем обновление, когда вкладка неактивна)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            if (isSearchActive) {
                searchChats(lastSearchQuery);
            } else {
                loadChats();
                loadStatistics();
            }
            startAutoUpdate();
        } else {
            clearInterval(updateInterval);
        }
    });
</script>
{% endblock %} 