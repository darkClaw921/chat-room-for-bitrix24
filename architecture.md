# Архитектура проекта чат-комнаты для Bitrix24

## Общая структура проекта

```
chat-room-for-bitrix24/
├── app/                      # Основной код приложения
│   ├── api/                  # API эндпоинты
│   │   ├── endpoints/        # Конкретные эндпоинты по категориям
│   │   │   ├── auth.py       # Авторизация и регистрация
│   │   │   ├── chats.py      # Работа с чатами
│   │   │   ├── messages.py   # Работа с сообщениями
│   │   │   ├── events.py     # Работа с событиями
│   │   │   └── webhook.py    # API для внешних интеграций
│   │   ├── deps.py           # Зависимости для API
│   │   └── router.py         # Маршрутизация API
│   ├── bot/                  # Telegram бот
│   │   ├── handlers/         # Обработчики сообщений и команд
│   │   │   ├── command.py    # Обработчики команд
│   │   │   └── message.py    # Обработчики сообщений
│   │   ├── middleware/       # Middleware для бота
│   │   └── bot.py            # Основной файл бота
│   ├── core/                 # Ядро приложения
│   │   ├── auth.py           # Аутентификация и авторизация
│   │   └── security.py       # Безопасность (хеширование, JWT)
│   ├── crud/                 # Операции с базой данных
│   │   ├── base.py           # Базовый CRUD
│   │   ├── user.py           # CRUD для пользователей
│   │   ├── chat.py           # CRUD для чатов
│   │   ├── message.py        # CRUD для сообщений
│   │   └── event.py          # CRUD для событий
│   ├── models/               # Модели базы данных
│   │   ├── base.py           # Базовая модель
│   │   ├── user.py           # Модели User и TelegramUser
│   │   ├── chat.py           # Модель Chat
│   │   ├── message.py        # Модель Message
│   │   └── event.py          # Модель Event
│   ├── schemas/              # Pydantic схемы
│   │   ├── user.py           # Схемы для пользователей
│   │   ├── chat.py           # Схемы для чатов
│   │   ├── message.py        # Схемы для сообщений
│   │   ├── event.py          # Схемы для событий
│   │   └── webhook.py        # Схемы для webhook API
│   ├── static/               # Статические файлы
│   │   ├── css/              # CSS стили
│   │   ├── js/               # JavaScript файлы
│   │   └── img/              # Изображения
│   ├── templates/            # HTML шаблоны
│   │   ├── auth/             # Шаблоны авторизации
│   │   ├── chats/            # Шаблоны чатов
│   │   ├── settings/         # Шаблоны настроек
│   │   ├── base.html         # Базовый шаблон
│   │   └── index.html        # Главная страница
│   ├── config.py             # Конфигурация приложения
│   ├── database.py           # Настройка базы данных
│   └── main.py               # Основной файл приложения
└── pyproject.toml            # Зависимости и метаданные проекта
```

## Описание компонентов

### Модели данных

1. **User** - Менеджеры системы (сотрудники Bitrix24)
   - Атрибуты: id, username, email, hashed_password, is_active, is_admin
   - Отношения: chats (один-ко-многим)

2. **TelegramUser** - Клиенты, использующие Telegram
   - Атрибуты: id, telegram_id, username, first_name, last_name, language_code, info
   - Отношения: chats (один-ко-многим), messages (один-ко-многим)

3. **Chat** - Чаты между менеджером и клиентом
   - Атрибуты: id, manager_id, telegram_user_id, title, is_active, unread_count
   - Отношения: manager (многие-к-одному), telegram_user (многие-к-одному), messages (один-ко-многим)

4. **Message** - Сообщения в чатах
   - Атрибуты: id, chat_id, telegram_user_id, manager_id, text, message_type, file_id, file_path, is_read, is_from_manager, read_at, telegram_message_id
   - Отношения: chat (многие-к-одному), telegram_user (многие-к-одному)

5. **Event** - События для автоматизации
   - Атрибуты: id, name, description, is_active, event_type, conditions, action_type, action_data, manager_id, telegram_user_id
   - Отношения: manager (многие-к-одному), telegram_user (многие-к-одному)

### API эндпоинты

1. **Авторизация** (`/api/auth/`)
   - Регистрация менеджеров
   - Вход в систему
   - Обновление токена
   - Получение информации о текущем пользователе

2. **Чаты** (`/api/chats/`)
   - Получение списка чатов
   - Создание нового чата
   - Получение информации о чате
   - Обновление информации о чате
   - Удаление чата

3. **Сообщения** (`/api/messages/`)
   - Получение сообщений чата
   - Отправка сообщения
   - Отметка сообщений как прочитанных
   - Удаление сообщения

4. **События** (`/api/events/`)
   - Получение списка событий
   - Создание нового события
   - Обновление события
   - Удаление события
   - Активация/деактивация события

5. **Webhook API** (`/api/webhook/`)
   - Отправка сообщений клиентам (`/api/webhook/send-message`)
   - Получение сообщений от клиентов (`/api/webhook/client-message`)

### Telegram бот

1. **Обработчики команд**
   - `/start` - Начало работы с ботом
   - `/help` - Получение справки

2. **Обработчики сообщений**
   - Текстовые сообщения
   - Медиа-сообщения (фото, документы)

### Веб-интерфейс

1. **Авторизация**
   - Страница входа
   - Восстановление пароля

2. **Чаты**
   - Список чатов
   - Детальная страница чата

3. **Настройки**
   - Общие настройки
   - Настройка событий

## Взаимодействие компонентов

1. Клиент отправляет сообщение боту в Telegram
2. Бот обрабатывает сообщение и сохраняет его в базе данных
3. Система проверяет наличие активных событий для данного сообщения
4. Если есть подходящие события, выполняются соответствующие действия
5. Менеджер получает уведомление о новом сообщении в веб-интерфейсе
6. Менеджер отвечает клиенту через веб-интерфейс
7. Система отправляет ответ клиенту через Telegram бота

## Интеграция с внешними системами

1. **Webhook API для отправки сообщений** (`/api/webhook/send-message`)
   - Позволяет отправлять сообщения клиентам от имени менеджеров через внешние запросы
   - Автоматически создает пользователей и чаты при необходимости

2. **Webhook API для получения сообщений** (`/api/webhook/client-message`)
   - Позволяет имитировать отправку сообщений от клиентов через внешние запросы
   - Сообщения появляются в интерфейсе менеджера как обычные сообщения от клиентов
   - Поддерживает автоматизацию через события 