# Архитектура проекта чат-комнаты для Bitrix24

## Общая структура проекта

```
chat-room-for-bitrix24/
├── app/                      # Основной код приложения
│   ├── api/                  # API эндпоинты
│   │   ├── endpoints/        # Конкретные эндпоинты по категориям
│   │   │   ├── auth.py       # Авторизация и регистрация
│   │   │   ├── chats.py      # Работа с чатами (с фильтрацией, сортировкой и статистикой)
│   │   │   ├── messages.py   # Работа с сообщениями
│   │   │   ├── events.py     # Работа с событиями
│   │   │   ├── webhook.py    # API для внешних интеграций
│   │   │   └── workBitrix.py # Интеграция с Bitrix24
│   │   ├── deps.py           # Зависимости для API
│   │   └── router.py         # Маршрутизация API
│   ├── bot/                  # Telegram бот
│   │   ├── handlers/         # Обработчики сообщений и команд
│   │   │   ├── command.py    # Обработчики команд
│   │   │   └── message.py    # Обработчики сообщений
│   │   ├── middleware/       # Middleware для бота
│   │   └── bot.py            # Основной файл бота
│   ├── core/                 # Ядро приложения
│   │   ├── auth.py           # Аутентификация и авторизация
│   │   ├── events.py         # Система событий и автоматизации
│   │   └── security.py       # Безопасность (хеширование, JWT)
│   ├── crud/                 # Операции с базой данных
│   │   ├── base.py           # Базовый CRUD
│   │   ├── user.py           # CRUD для пользователей
│   │   ├── chat.py           # CRUD для чатов (с фильтрацией, сортировкой и статистикой)
│   │   ├── message.py        # CRUD для сообщений
│   │   └── event.py          # CRUD для событий
│   ├── models/               # Модели базы данных
│   │   ├── base.py           # Базовая модель
│   │   ├── user.py           # Модели User и TelegramUser
│   │   ├── chat.py           # Модель Chat
│   │   ├── message.py        # Модель Message
│   │   └── event.py          # Модель Event
│   ├── schemas/              # Pydantic схемы
│   │   ├── user.py           # Схемы для пользователей
│   │   ├── chat.py           # Схемы для чатов (включая фильтры и статистику)
│   │   ├── message.py        # Схемы для сообщений
│   │   ├── event.py          # Схемы для событий
│   │   └── webhook.py        # Схемы для webhook API
│   ├── static/               # Статические файлы
│   │   ├── css/              # CSS стили
│   │   ├── js/               # JavaScript файлы
│   │   └── img/              # Изображения
│   ├── templates/            # HTML шаблоны
│   │   ├── auth/             # Шаблоны авторизации
│   │   ├── chats/            # Шаблоны чатов (с фильтрацией и сортировкой)
│   │   ├── settings/         # Шаблоны настроек
│   │   ├── base.html         # Базовый шаблон
│   │   └── index.html        # Главная страница (со счетчиками статистики)
│   ├── config.py             # Конфигурация приложения
│   ├── database.py           # Настройка базы данных
│   └── main.py               # Основной файл приложения
└── pyproject.toml            # Зависимости и метаданные проекта
```

## Описание компонентов

### Модели данных

1. **User** - Менеджеры системы (сотрудники Bitrix24)
   - Атрибуты: id, username, email, hashed_password, is_active, is_admin
   - Отношения: chats (один-ко-многим)
   - **Примечание**: При первой инициализации базы данных автоматически создается пользователь администратор с учетными данными, указанными в переменных окружения (ADMIN_USERNAME, ADMIN_PASSWORD, ADMIN_EMAIL), если он еще не существует.

2. **TelegramUser** - Клиенты, использующие Telegram
   - Атрибуты: id, telegram_id, username, first_name, last_name, language_code, info
   - Отношения: chats (один-ко-многим), messages (один-ко-многим)

3. **Chat** - Чаты между менеджером и клиентом
   - Атрибуты: id, manager_id, telegram_user_id, title, is_active, unread_count
   - Отношения: manager (многие-к-одному), telegram_user (многие-к-одному), messages (один-ко-многим)

4. **Message** - Сообщения в чатах
   - Атрибуты: id, chat_id, telegram_user_id, manager_id, text, message_type, file_id, file_path, is_read, is_from_manager, read_at, telegram_message_id
   - Отношения: chat (многие-к-одному), telegram_user (многие-к-одному)

5. **Event** - События для автоматизации
   - Атрибуты: id, name, description, is_active, event_type, conditions, action_type, action_data, manager_id, telegram_user_id
   - Отношения: manager (многие-к-одному), telegram_user (многие-к-одному)

### API эндпоинты

1. **Авторизация** (`/api/auth/`)
   - Регистрация менеджеров
   - Вход в систему
   - Обновление токена
   - Получение информации о текущем пользователе

2. **Чаты** (`/api/chats/`)
   - Получение списка чатов с поддержкой фильтрации и сортировки
     - Фильтр по дате: сегодня, вчера, пользовательская дата
     - Сортировка по дате обновления чата или дате последнего сообщения
     - Порядок сортировки: по возрастанию/убыванию
   - Создание нового чата
   - Получение информации о чате
   - Обновление информации о чате
   - Удаление чата
   - Поиск чатов

3. **Статистика** (`/api/stats/`)
   - Получение статистики дашборда (`/api/stats/`)
     - Количество новых сообщений за сегодня, неделю, месяц
     - Количество новых диалогов за сегодня, неделю, месяц

4. **Сообщения** (`/api/messages/`)
   - Получение сообщений чата
   - Отправка сообщения
   - Отметка сообщений как прочитанных
   - Удаление сообщения

5. **События** (`/api/events/`)
   - Получение списка событий
   - Создание нового события
   - Обновление события
   - Удаление события
   - Активация/деактивация события

6. **Webhook API** (`/api/webhook/`)
   - Отправка сообщений клиентам (`/api/webhook/send-message`)
   - Получение сообщений от клиентов (`/api/webhook/client-message`)

7. **Интеграция с Bitrix24** (`app/api/endpoints/workBitrix.py`)
   - Отправка уведомлений менеджерам в Bitrix24
   - Автоматические уведомления если сообщение не прочитано в течение 10 секунд
   - Получение информации о сделках из Bitrix24

### Telegram бот

1. **Обработчики команд**
   - `/start` - Начало работы с ботом
   - `/help` - Получение справки

2. **Обработчики сообщений**
   - Текстовые сообщения
   - Медиа-сообщения (фото, документы)

### Веб-интерфейс

1. **Главная страница** (`/`)
   - Информация о системе
   - Кнопки навигации для авторизованных и неавторизованных пользователей
   - Описание основной функциональности

2. **Авторизация**
   - Страница входа
   - Восстановление пароля

3. **Чаты** (`/chats`)
   - Статистика активности:
     - Новые сообщения за сегодня, неделю, месяц
     - Новые диалоги за сегодня, неделю, месяц
     - Автоматическое обновление каждые 30 секунд
   - Список чатов с расширенными возможностями:
     - Панель фильтров и сортировки (сворачиваемая)
     - Фильтрация по дате: все время, сегодня, вчера, пользовательская дата
     - Сортировка по дате обновления чата или дате последнего сообщения
     - Порядок сортировки: по возрастанию/убыванию
     - Поиск по названию чата или имени пользователя
   - Детальная страница чата

4. **Настройки**
   - Общие настройки
   - Настройка событий

### Новая функциональность фильтрации и статистики

#### Фильтрация чатов
- **По дате**: фильтрация чатов по дате последних сообщений
  - "Сегодня" - чаты с сообщениями за текущий день
  - "Вчера" - чаты с сообщениями за предыдущий день
  - Пользовательская дата - чаты с сообщениями за выбранную дату
- **Сортировка**: 
  - По дате обновления чата (`updated_at`)
  - По дате последнего сообщения (`last_message_date`)
  - Порядок: по возрастанию или убыванию

#### Статистика дашборда
- **Счетчики сообщений**: количество новых сообщений от клиентов
  - За сегодня
  - За неделю (последние 7 дней)
  - За месяц (последние 30 дней)
- **Счетчики диалогов**: количество новых чатов
  - За сегодня
  - За неделю (последние 7 дней) 
  - За месяц (последние 30 дней)

#### Схемы данных
- `ChatFilters` - параметры фильтрации чатов
- `Statistics` - базовая схема статистики (сегодня, неделя, месяц)
- `DashboardStatistics` - комплексная статистика для дашборда

## Взаимодействие компонентов

1. Клиент отправляет сообщение боту в Telegram
2. Бот обрабатывает сообщение и сохраняет его в базе данных
3. Система запускает таймер на 10 секунд
4. Если менеджер не прочитал сообщение в течение 10 секунд, отправляется уведомление в Bitrix24
5. Если менеджер прочитал сообщение в течение 10 секунд, уведомление не отправляется
6. Система проверяет наличие активных событий для данного сообщения
7. Если есть подходящие события, выполняются соответствующие действия
8. Менеджер получает уведомление о новом сообщении в веб-интерфейсе
9. Менеджер может использовать фильтры и сортировку для управления списком чатов
10. Статистика на главной странице показывает актуальную информацию об активности
11. Менеджер отвечает клиенту через веб-интерфейс
12. Система отправляет ответ клиенту через Telegram бота

## Интеграция с внешними системами

1. **Webhook API для отправки сообщений** (`/api/webhook/send-message`)
   - Позволяет отправлять сообщения клиентам от имени менеджеров через внешние запросы
   - Автоматически создает пользователей и чаты при необходимости
   - Поддерживает отправку файлов в формате base64 (поле file с параметрами name и data)

2. **Webhook API для получения сообщений** (`/api/webhook/client-message`)
   - Позволяет имитировать отправку сообщений от клиентов через внешние запросы
   - Сообщения появляются в интерфейсе менеджера как обычные сообщения от клиентов
   - Поддерживает автоматизацию через события 
   - Поддерживает отправку файлов в формате base64 (поле file с параметрами name и data)
   - Автоматически отправляет уведомление в Bitrix24, если менеджер не прочитает сообщение в течение 10 секунд

3. **Интеграция с Bitrix24**
   - Отправка уведомлений менеджерам в Bitrix24 о новых непрочитанных сообщениях
   - Получение информации о сделках из Bitrix24
   - Автоматическое связывание клиентов с сделками в Bitrix24

## Технические особенности

### Производительность
- Использование SQL JOIN для эффективной сортировки по дате последнего сообщения
- Подзапросы для фильтрации чатов по дате сообщений
- Оптимизированные запросы с предварительной загрузкой связанных объектов (joinedload)
- Автоматическое обновление данных через JavaScript каждые 30 секунд

### Пользовательский интерфейс
- Сворачиваемая панель фильтров для экономии места
- Интуитивные элементы управления фильтрацией и сортировкой
- Визуальные счетчики статистики с цветовой индикацией на странице чатов
- Автоматическое отключение элементов при неактивности вкладки браузера
- Умные сообщения при отсутствии результатов (различаются в зависимости от применения фильтров)
- Индикаторы загрузки при применении фильтров

### Логирование и отладка
- Использование стандартного Python логгера вместо print
- Подробные логи в консоли браузера для диагностики
- Отслеживание всех операций фильтрации и сортировки
- Обработка ошибок с понятными сообщениями пользователю

### API архитектура
- Отдельный эндпоинт `/api/stats/` для статистики во избежание конфликтов маршрутизации
- Параметризованные запросы для фильтрации и сортировки
- Поддержка пользовательских дат в формате YYYY-MM-DD
- Гибкая система сортировки (по возрастанию/убыванию) 